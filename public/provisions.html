<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fund Movements</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css"
    integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl5/1z7/ppx1z8+M8z1t5h/5fffdQoi5g5t8GA/IRX" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/tr.js"></script>

  <script>
    $(document).ready(async function () {
      let currentPage = 0;
      const pageSize = 25;
      const customerId = 3172;
      const today = new Date();
      const formattedToday = today.toISOString().slice(0, 10);
      $("#minDate").val(formattedToday);
      $("#maxDate").val(formattedToday);

      const fetchprovisions = async (customerId, page, minDate, maxDate) => {
  const response = await fetch(`http://localhost:3000/fundMovement/pay`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ customerId: customerId, page: page, minDate: minDate, maxDate: maxDate })
  });
  const data = await response.json();
  return data.data; // Burada "data" yerine "data.data" döndürüyoruz.
};


const sortprovisions = (provisions) => {
  return provisions.sort((a, b) => {
    return new Date(a.formattedDate) - new Date(b.formattedDate);
  });
};




      const filterprovisionsByCustomerId = (data, customerId) => {
        return data.filter(item => item.customer_id === customerId);
      };



      const renderprovisions = (provisions) => {
        const tbody = $('#provisionsTable tbody');
        tbody.empty();

        provisions.forEach((element) => {
          const date = new Date(element.date * 1000).toLocaleDateString('tr-TR');
          const installmentTotal = parseInt(element.installment) + parseInt(element.installment_plus);
          const amountFormatted = parseFloat(element.amount).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }).replace("₺", " ");

          const row = $('<tr></tr>');
          row.append(`<td data-label='Tarih'>${date}</td>`);
          row.append(`<td data-label='İşlem No'>${element.transaction_no.slice(6, -3)}</td>`);
          row.append(`<td data-label='Firma'>${element.customer_company}</td>`);
          row.append(`<td data-label='Banka'>${element.card_bank}</td>`);
          row.append(`<td data-label='Kart Sahibi'>${element.card_holder}</td>`);
          row.append(`<td data-label='Taksit'>${element.installment} + ${element.installment_plus}</td>`);
          row.append(`<td data-label='Tutar' class='amount-cell' style="text-align: right;">${amountFormatted}</td>`);

          tbody.append(row);
        });
      };

      $('#filterButton').click(async () => {
  currentPage = 0;
  updatePagination();
});



const updatePagination = async () => {
  const tbody = $('#provisionsTable tbody');
  tbody.empty(); // Veri getirme işlemine başlamadan önce tabloyu temizleyin.
  
  const minDate = $('#minDate').val();
  const maxDate = $('#maxDate').val();
  const provisions = await fetchprovisions(customerId, currentPage, minDate, maxDate);
  const sortedprovisions = sortprovisions(provisions);
  renderprovisions(sortedprovisions);
  $('#currentPage').text(currentPage + 1);
};



      (async function () {
        const provisions = await fetchprovisions(customerId);
        renderprovisions(provisions);

        $("#pagination").on("click", "a.page-link", async function (event) {
          event.preventDefault();
          currentPage = parseInt($(this).text()) - 1;
          updatePagination();
        });

        $('#previousPage').click(async () => {
          if (currentPage > 0) {
            currentPage -= 1;
            updatePagination();
          }
        });

        $('#nextPage').click(async () => {
          currentPage += 1;
          updatePagination();
        });

        updatePagination();
      })();


    });


    function formatMoney(amount, decimalCount, decimal = ".", thousands = ",") {
      decimalCount = Math.abs(decimalCount);
      decimalCount = isNaN(decimalCount) ? 2 : decimalCount;

      const negativeSign = amount < 0 ? "-" : "";

      const i = parseInt(amount = Math.abs(Number(amount) || 0).toFixed(decimalCount)).toString();
      const j = (i.length > 3) ? i.length % 3 : 0;

      return negativeSign + (j ? i.substr(0, j) + thousands : '') + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousands) + (decimalCount ? decimal + Math.abs(amount - i).toFixed(decimalCount).slice(2) : "");
    }


  </script>
</head>

<body>
  <div class="container">
    <h1>provisions</h1>
<div class="row mt-3">
  <div class="col-md-4">
    <label for="minDate">Başlangıç Tarihi:</label>
    <input type="date" id="minDate" class="form-control">
  </div>
  <div class="col-md-4">
    <label for="maxDate">Bitiş Tarihi:</label>
    <input type="date" id="maxDate" class="form-control">
  </div>
  <div class="col-md-4">
    <button id="filterButton" class="btn btn-primary mt-4">Filtrele</button>
  </div>
</div>

    <table id="provisionsTable" class="table table-striped">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Referans No</th>
          <th>Firma</th>
          <th>Banka</th>
          <th>Kart Sahibi</th>
          <th>Taksit</th>
          <th style="text-align: right;">Tutar</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <nav>
      <ul class="pagination">
        <li class="page-item">
          <a id="previousPage" class="page-link" href="#">Previous</a>
        </li>
        <li class="page-item">
          <span id="currentPage" class="page-link">1</span>
        </li>
        <li class="page-item">
          <a id="nextPage" class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</body>

</html>