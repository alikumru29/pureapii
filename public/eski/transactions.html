<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fund Movements</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css"
    integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl5/1z7/ppx1z8+M8z1t5h/5fffdQoi5g5t8GA/IRX" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/tr.js"></script>

  <script>
    $(document).ready(async function () {
      let currentPage = 0;
      const pageSize = 25;
      const customerId = 3912;
      const today = new Date();
      const formattedToday = today.toISOString().split('T')[0];
      $('#minDate').val(formattedToday);
      $('#maxDate').val(formattedToday);

      $('#filterForm').on('submit', async (event) => {
        event.preventDefault();
        const minDate = $('#minDate').val().split('-').reverse().join('-');
        const maxDate = $('#maxDate').val().split('-').reverse().join('-');
        const fundMovements = await fetchFundMovements(customerId, currentPage, minDate, maxDate);
        renderFundMovements(fundMovements);
      });

      const fetchFundMovements = async (customerId, page, minDate, maxDate) => {
        const response = await fetch(`http://localhost:3000/fundMovement/getFundMovements`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ customerId: customerId, page: page, minDate: minDate, maxDate: maxDate })
        });
        const data = await response.json();
        return data;
      };

      



      const filterFundMovementsByCustomerId = (data, customerId) => {
        return data.filter(item => item.customer_id === customerId);
      };



      const renderFundMovements = (fundMovements) => {
        fundMovements.sort((a, b) => {
          const dateA = new Date(a.create_date_f);
          const dateB = new Date(b.create_date_f);
          return dateA - dateB;
        });
        const tbody = $('#fundMovementsTable tbody');
        tbody.empty();

        fundMovements.forEach((element) => {
          const date = new Date(element.create_date_f);
          let transactionNo = element.transaction_no;
          if (transactionNo.startsWith('CO')) {
            transactionNo = transactionNo.slice(6, -3);
          }
          let formattedDescription = element.description;
          if (transactionNo.startsWith('CO')) {
            formattedDescription = 'Tahsilat Makbuzu';
          }
          const formattedDate = ('0' + date.getDate()).slice(-2) + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + date.getFullYear();
          const formattedDebt = formatMoney(element.debt, 2, ",", ".");
          const formattedCredit = formatMoney(element.credit, 2, ",", ".");
          let formattedBalance;
          if (element._balance < 0) {
            formattedBalance = formatMoney(Math.abs(element._balance), 2, ",", ".");
          } else if (element._balance > 0) {
            formattedBalance = "-" + formatMoney(element._balance, 2, ",", ".");
          } else {
            formattedBalance = "0,00";
          }

          const debtColor = element.debt > 0 ? 'text-danger font-weight-bold' : '';
          const creditColor = element.credit > 0 ? 'text-success font-weight-bold' : '';
          const balanceColor = element.debt > 0 ? 'text-danger font-weight-bold' : (element.credit > 0 ? 'text-success font-weight-bold' : '');

          const row = $('<tr></tr>');
          row.append(`<td>${formattedDate}</td>`);
          row.append(`<td>${transactionNo}</td>`);
          row.append(`<td>${formattedDescription}</td>`);
          row.append(`<td class="${debtColor}" style="text-align: right;">${formattedDebt}</td>`);
          row.append(`<td class="${creditColor}" style="text-align: right;">${formattedCredit}</td>`);
          row.append(`<td style="text-align: right;">${formattedBalance}</td>`);

          tbody.append(row);
        });
      };



      const updatePagination = async (minDate, maxDate) => {
        const fundMovements = await fetchFundMovements(customerId, currentPage, minDate, maxDate);
        renderFundMovements(fundMovements);
        $('#currentPage').text(currentPage + 1);
      };


      (async function () {
        const minDate = $('#minDate').val().split('-').reverse().join('-');
        const maxDate = $('#maxDate').val().split('-').reverse().join('-');
        const fundMovements = await fetchFundMovements(customerId, currentPage, minDate, maxDate);
        renderFundMovements(fundMovements);

        $("#pagination").on("click", "a.page-link", async function (event) {
          event.preventDefault();
          currentPage = parseInt($(this).text()) - 1;
          updatePagination(minDate, maxDate);
        });

        $('#previousPage').click(async () => {
          if (currentPage > 0) {
            currentPage -= 1;
            updatePagination(minDate, maxDate);
          }
        });

        $('#nextPage').click(async () => {
          currentPage += 1;
          updatePagination(minDate, maxDate);
        });

        updatePagination(minDate, maxDate);
      })();


    });


    function formatMoney(amount, decimalCount, decimal = ".", thousands = ",") {
      decimalCount = Math.abs(decimalCount);
      decimalCount = isNaN(decimalCount) ? 2 : decimalCount;

      const negativeSign = amount < 0 ? "-" : "";

      const i = parseInt(amount = Math.abs(Number(amount) || 0).toFixed(decimalCount)).toString();
      const j = (i.length > 3) ? i.length % 3 : 0;

      return negativeSign + (j ? i.substr(0, j) + thousands : '') + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousands) + (decimalCount ? decimal + Math.abs(amount - i).toFixed(decimalCount).slice(2) : "");
    }


  </script>
</head>

<body>
  <div class="container">
    <h1>Fund Movements</h1>
    <form id="filterForm" class="mb-3">
      <div class="row">
        <div class="col">
          <label for="minDate" class="form-label">Başlangıç Tarihi</label>
          <input type="date" class="form-control" id="minDate" placeholder="DD-MM-YYYY">
        </div>
        <div class="col">
          <label for="maxDate" class="form-label">Bitiş Tarihi</label>
          <input type="date" class="form-control" id="maxDate" placeholder="DD-MM-YYYY">
        </div>
        <div class="col d-flex align-items-end">
          <button type="submit" class="btn btn-primary">Filtrele</button>
        </div>
      </div>
    </form>
    <table id="fundMovementsTable" class="table table-striped">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Referans No</th>
          <th>Açıklama</th>
          <th style="text-align: right;">Borç</th>
          <th style="text-align: right;">Alacak</th>
          <th style="text-align: right;">Bakiye</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <nav>
      <ul class="pagination">
        <li class="page-item">
          <a id="previousPage" class="page-link" href="#">Previous</a>
        </li>
        <li class="page-item">
          <span id="currentPage" class="page-link">1</span>
        </li>
        <li class="page-item">
          <a id="nextPage" class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</body>

</html>